---
apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: calibre
  namespace: media
spec:
  chart:
    spec:
      chart: app-template
      version: 2.5.0
      interval: 15m
      sourceRef:
        kind: HelmRepository
        name: bjw-s
        namespace: flux-system
  interval: 15m
values:
  defaultPodOptions:
    enableServiceLinks: false
    securityContext:
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: OnRootMismatch
      supplementalGroups: [44, 105, 10000, 568]
  controllers:
    main:
      containers:
        main:
          image:
            repository: ghcr.io/linuxserver/calibre
            tag: version-v7.4.0@sha256:f372e1a05619472f382578253907f969647f81b24acc444319a99bdb661ff58a
          env:
            TZ: "${TIMEZONE}"
            PUID: "1026"
            PGID: "1000"
          resources:
            requests:
              cpu: 15m
              memory: 324M
            limits:
              memory: 604M
  service:
    main:
      enabled: true
      controller: main
      ports:
        http:
          enabled: true
          port: 8080
  ingress:
    main:
      enabled: true
      className: external-nginx
      annotations:
        external-dns/is-public: "true"
        hajimari.io/enable: "true"
        hajimari.io/icon: bookshelf
      hosts:
        - host: &host calibre.${EXTERNAL_DOMAIN}
          paths:
            - path: /
              service:
                name: main
                port: http
      tls:
        - hosts:
            - *host
  persistence:
    config:
      enabled: true
      existingClaim: calibre-config-v2
      globalMounts:
        - path: /config
    books:
      enabled: true
      type: nfs
      server: "10.0.1.6"
      path: /mnt/storage-0/media/books
      globalMounts:
        - path: /media
