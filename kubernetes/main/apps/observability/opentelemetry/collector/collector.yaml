---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: otel-collector
spec:
  interval: 5m
  timeout: 10m
  install:
    timeout: 10m
  chart:
    spec:
      chart: opentelemetry-collector
      version: 0.93.3
      sourceRef:
        kind: HelmRepository
        name: opentelemetry-charts
        namespace: flux-system
  values:
    fullnameOverride: "opentelemetry-collector"
    # Valid values are "daemonset", "deployment", and "statefulset".
    mode: "daemonset"
    # Handles basic configuration of components that
    # also require k8s modifications to work correctly.
    # .Values.config can be used to modify/add to a preset
    # component configuration, but CANNOT be used to remove
    # preset configuration. If you require removal of any
    # sections of a preset configuration, you cannot use
    # the preset. Instead, configure the component manually in
    # .Values.config and use the other fields supplied in the
    # values.yaml to configure k8s as necessary.
    presets:
      # Configures the collector to collect logs.
      # Adds the filelog receiver to the logs pipeline
      # and adds the necessary volumes and volume mounts.
      # Best used with mode = daemonset.
      logsCollection:
        enabled: true
        includeCollectorLogs: true
        # Enabling this writes checkpoints in /var/lib/otelcol/ host directory.
        # Note this changes collector's user to root, so that it can write to host directory.
        storeCheckpoints: false
      # Configures the collector to collect host metrics.
      # Adds the hostmetrics receiver to the metrics pipeline
      # and adds the necessary volumes and volume mounts.
      # Best used with mode = daemonset.
      hostMetrics:
        enabled: true
      # Configures the Kubernetes Processor to add Kubernetes metadata.
      # Adds the k8sattributes processor to all the pipelines
      # and adds the necessary rules to ClusteRole.
      # Best used with mode = daemonset.
      kubernetesAttributes:
        enabled: true
      # Configures the Kubernetes Cluster Receiver to collect cluster-level metrics.
      # Adds the k8s_cluster receiver to the metrics pipeline
      # and adds the necessary rules to ClusteRole.
      # Best used with mode = deployment or statefulset.
      clusterMetrics:
        enabled: true
      # Configures the collector to collect Kubelet metrics.
      # Adds the kubeletstats receiver to the metrics pipeline
      # and adds the necessary rules to ClusteRole.
      # Best used with mode = daemonset.
      kubeletMetrics:
        enabled: true
    config:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: 0.0.0.0:4317
            http:
              endpoint: 0.0.0.0:4318
      processors:
        batch: {}
      exporters:
        otlphttp:
          endpoint: http://loki-gateway.observability.svc.cluster.local/oltp
      pipelines:
        logs:
          exporters:
            - otlphttp
          processors:
            - batch
          receivers:
            - otlp
